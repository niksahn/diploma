============================= test session starts =============================
platform win32 -- Python 3.12.2, pytest-8.1.1, pluggy-1.4.0 -- C:\Users\niksa\AppData\Local\Programs\Python\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\projects\diploma
plugins: anyio-4.6.2.post1, hydra-core-1.3.2, cov-4.1.0, docker-3.2.5
collecting ... collected 39 items

tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_success PASSED [  2%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_duplicate_login PASSED [  5%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_invalid_login_too_short PASSED [  7%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_invalid_login_too_long PASSED [ 10%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_invalid_password_too_short PASSED [ 12%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_invalid_surname_too_short PASSED [ 15%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_invalid_name_too_short PASSED [ 17%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_missing_required_fields PASSED [ 20%]
tests/services/auth/test_auth_endpoints.py::TestUserRegister::test_register_without_patronymic PASSED [ 23%]
tests/services/auth/test_auth_endpoints.py::TestUserLogin::test_login_success FAILED [ 25%]
tests/services/auth/test_auth_endpoints.py::TestUserLogin::test_login_invalid_credentials PASSED [ 28%]
tests/services/auth/test_auth_endpoints.py::TestUserLogin::test_login_wrong_password PASSED [ 30%]
tests/services/auth/test_auth_endpoints.py::TestUserLogin::test_login_missing_fields PASSED [ 33%]
tests/services/auth/test_auth_endpoints.py::TestRefreshToken::test_refresh_success FAILED [ 35%]
tests/services/auth/test_auth_endpoints.py::TestRefreshToken::test_refresh_invalid_token PASSED [ 38%]
tests/services/auth/test_auth_endpoints.py::TestRefreshToken::test_refresh_missing_token PASSED [ 41%]
tests/services/auth/test_auth_endpoints.py::TestRefreshToken::test_refresh_revoked_token PASSED [ 43%]
tests/services/auth/test_auth_endpoints.py::TestLogout::test_logout_success PASSED [ 46%]
tests/services/auth/test_auth_endpoints.py::TestLogout::test_logout_without_token PASSED [ 48%]
tests/services/auth/test_auth_endpoints.py::TestLogout::test_logout_invalid_token PASSED [ 51%]
tests/services/auth/test_auth_endpoints.py::TestAdminLogin::test_admin_login_success PASSED [ 53%]
tests/services/auth/test_auth_endpoints.py::TestAdminLogin::test_admin_login_invalid_credentials PASSED [ 56%]
tests/services/auth/test_auth_endpoints.py::TestAdminLogin::test_admin_login_wrong_password PASSED [ 58%]
tests/services/auth/test_auth_endpoints.py::TestAdminLogin::test_admin_login_missing_fields PASSED [ 61%]
tests/services/auth/test_auth_endpoints.py::TestAdminRegister::test_admin_register_success PASSED [ 64%]
tests/services/auth/test_auth_endpoints.py::TestAdminRegister::test_admin_register_duplicate_login PASSED [ 66%]
tests/services/auth/test_auth_endpoints.py::TestAdminRegister::test_admin_register_invalid_password_too_short FAILED [ 69%]
tests/services/auth/test_auth_endpoints.py::TestAdminRegister::test_admin_register_missing_fields PASSED [ 71%]
tests/services/auth/test_auth_endpoints.py::TestValidateToken::test_validate_success PASSED [ 74%]
tests/services/auth/test_auth_endpoints.py::TestValidateToken::test_validate_admin_token PASSED [ 76%]
tests/services/auth/test_auth_endpoints.py::TestValidateToken::test_validate_without_token PASSED [ 79%]
tests/services/auth/test_auth_endpoints.py::TestValidateToken::test_validate_invalid_token PASSED [ 82%]
tests/services/auth/test_auth_endpoints.py::TestValidateToken::test_validate_refresh_token_rejected PASSED [ 84%]
tests/services/user/test_user_endpoints.py::TestUserProfile::test_get_me_success FAILED [ 87%]
tests/services/user/test_user_endpoints.py::TestUserProfile::test_update_me_success FAILED [ 89%]
tests/services/user/test_user_endpoints.py::TestUserProfile::test_update_status FAILED [ 92%]
tests/services/user/test_user_endpoints.py::TestUserSearch::test_search_users PASSED [ 94%]
tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users FAILED [ 97%]
tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users ERROR [ 97%]
tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users_forbidden FAILED [100%]
tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users_forbidden ERROR [100%]

=================================== ERRORS ====================================
______ ERROR at teardown of TestWorkspaceUsers.test_get_workspace_users _______

db_cursor = <cursor object at 0x00000233CBBB8D70; closed: -1>

    @pytest.fixture
    def clean_workspace_data(db_cursor):
        """╬ўшёЄър фрээ√ї Ёрсюўшї яЁюёЄЁрэёЄт яюёых ЄхёЄр"""
        yield
        # ╬ўш∙рхь ЄрсышЎ√, ёт чрээ√х ё workspaces
        # ╧юЁ фюъ трцхэ шч-чр тэх°эшї ъы■ўхщ
>       db_cursor.execute('DELETE FROM "userInWorkspace"')

tests\services\user\conftest.py:65: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <cursor object at 0x00000233CBBB8D70; closed: -1>
query = 'DELETE FROM "userInWorkspace"', vars = None

    def execute(self, query, vars=None):
        self.column_mapping = []
        self._query_executed = True
>       return super().execute(query, vars)
E       psycopg2.errors.UndefinedTable: relation "userInWorkspace" does not exist
E       LINE 1: DELETE FROM "userInWorkspace"
E                           ^

C:\Users\niksa\AppData\Local\Programs\Python\Python312\Lib\site-packages\psycopg2\extras.py:236: UndefinedTable
_ ERROR at teardown of TestWorkspaceUsers.test_get_workspace_users_forbidden __

db_cursor = <cursor object at 0x00000233CBBB9040; closed: -1>

    @pytest.fixture
    def clean_workspace_data(db_cursor):
        """╬ўшёЄър фрээ√ї Ёрсюўшї яЁюёЄЁрэёЄт яюёых ЄхёЄр"""
        yield
        # ╬ўш∙рхь ЄрсышЎ√, ёт чрээ√х ё workspaces
        # ╧юЁ фюъ трцхэ шч-чр тэх°эшї ъы■ўхщ
>       db_cursor.execute('DELETE FROM "userInWorkspace"')

tests\services\user\conftest.py:65: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <cursor object at 0x00000233CBBB9040; closed: -1>
query = 'DELETE FROM "userInWorkspace"', vars = None

    def execute(self, query, vars=None):
        self.column_mapping = []
        self._query_executed = True
>       return super().execute(query, vars)
E       psycopg2.errors.UndefinedTable: relation "userInWorkspace" does not exist
E       LINE 1: DELETE FROM "userInWorkspace"
E                           ^

C:\Users\niksa\AppData\Local\Programs\Python\Python312\Lib\site-packages\psycopg2\extras.py:236: UndefinedTable
================================== FAILURES ===================================
______________________ TestUserLogin.test_login_success _______________________

self = <tests.services.auth.test_auth_endpoints.TestUserLogin object at 0x00000233CBA45850>
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
valid_user_data = {'login': 'testuser1764503938509@example.com', 'name': 'Ivan', 'password': 'SecurePassword123', 'patronymic': 'Ivanovich', ...}
login_data = {'login': 'testuser1764503938509@example.com', 'password': 'SecurePassword123'}

    def test_login_success(self, base_url, api_path, valid_user_data, login_data):
        """╙ёях°э√щ тїюф яюы№чютрЄхы """
        # ╤эрўрыр ЁхушёЄЁшЁєхь яюы№чютрЄхы 
        register_url = f"{base_url}{api_path}/register"
        requests.post(register_url, json=valid_user_data)
    
        # ┬√яюыэ хь тїюф
        login_url = f"{base_url}{api_path}/login"
        response = requests.post(login_url, json=login_data)
    
        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data
        assert "expires_in" in data
        assert data["expires_in"] == 3600
        assert "user" in data
        assert data["user"]["login"] == login_data["login"]
        assert data["user"]["id"] > 0
>       assert data["user"]["status"] == 1  # ╤ЄрЄєё фюыцхэ с√Є№ "╬эырщэ"
E       assert 0 == 1

tests\services\auth\test_auth_endpoints.py:151: AssertionError
____________________ TestRefreshToken.test_refresh_success ____________________

self = <tests.services.auth.test_auth_endpoints.TestRefreshToken object at 0x00000233CBA455B0>
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
valid_user_data = {'login': 'testuser1764503939440@example.com', 'name': 'Ivan', 'password': 'SecurePassword123', 'patronymic': 'Ivanovich', ...}
login_data = {'login': 'testuser1764503939440@example.com', 'password': 'SecurePassword123'}

    def test_refresh_success(self, base_url, api_path, valid_user_data, login_data):
        """╙ёях°эюх юсэютыхэшх access Єюъхэр"""
        # ╨хушёЄЁшЁєхь ш тїюфшь
        register_url = f"{base_url}{api_path}/register"
        requests.post(register_url, json=valid_user_data)
    
        login_url = f"{base_url}{api_path}/login"
        login_response = requests.post(login_url, json=login_data)
        refresh_token = login_response.json()["refresh_token"]
    
        # ╬сэюты хь Єюъхэ
        refresh_url = f"{base_url}{api_path}/refresh"
        response = requests.post(refresh_url, json={"refresh_token": refresh_token})
    
>       assert response.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response [500]>.status_code

tests\services\auth\test_auth_endpoints.py:212: AssertionError
______ TestAdminRegister.test_admin_register_invalid_password_too_short _______

self = <tests.services.auth.test_auth_endpoints.TestAdminRegister object at 0x00000233CBA47500>
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
unique_timestamp = 1764503942345

    def test_admin_register_invalid_password_too_short(self, base_url, api_path, unique_timestamp):
        """╨хушёЄЁрЎш  рфьшэшёЄЁрЄюЁр ё ярЁюыхь ьхэхх 8 ёшьтюыют фюыцэр тхЁэєЄ№ 400"""
        invalid_data = {
            "login": f"admin{unique_timestamp}@example.com",
            "password": "short"
        }
        url = f"{base_url}{api_path}/admin/register"
        response = requests.post(url, json=invalid_data)
    
>       assert response.status_code == 400
E       assert 201 == 400
E        +  where 201 = <Response [201]>.status_code

tests\services\auth\test_auth_endpoints.py:413: AssertionError
_____________________ TestUserProfile.test_get_me_success _____________________

self = <test_user_endpoints.TestUserProfile object at 0x00000233CBAC66C0>
user_service_url = 'http://localhost:8082', user_api_path = '/api/v1/users'
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
valid_user_data = {'login': 'testuser1764503943903@example.com', 'name': 'Ivan', 'password': 'SecurePassword123', 'patronymic': 'Ivanovich', ...}
login_data = {'login': 'testuser1764503943903@example.com', 'password': 'SecurePassword123'}

    def test_get_me_success(self, user_service_url, user_api_path, base_url, api_path, valid_user_data, login_data):
        """╧юыєўхэшх ётюхую яЁюЇшы """
        # ╨хушёЄЁшЁєхь ш тїюфшь
        register_url = f"{base_url}{api_path}/register"
        requests.post(register_url, json=valid_user_data)
    
        login_url = f"{base_url}{api_path}/login"
        login_response = requests.post(login_url, json=login_data)
        access_token = login_response.json()["access_token"]
    
        # ╧юыєўрхь яЁюЇшы№
        url = f"{user_service_url}{user_api_path}/me"
        response = requests.get(url, headers={"Authorization": f"Bearer {access_token}"})
    
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401]>.status_code

tests\services\user\test_user_endpoints.py:35: AssertionError
___________________ TestUserProfile.test_update_me_success ____________________

self = <test_user_endpoints.TestUserProfile object at 0x00000233CBAC6990>
user_service_url = 'http://localhost:8082', user_api_path = '/api/v1/users'
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
valid_user_data = {'login': 'testuser1764503944341@example.com', 'name': 'Ivan', 'password': 'SecurePassword123', 'patronymic': 'Ivanovich', ...}
login_data = {'login': 'testuser1764503944341@example.com', 'password': 'SecurePassword123'}

    def test_update_me_success(self, user_service_url, user_api_path, base_url, api_path, valid_user_data, login_data):
        """╬сэютыхэшх ётюхую яЁюЇшы """
        # ╨хушёЄЁшЁєхь ш тїюфшь
        requests.post(f"{base_url}{api_path}/register", json=valid_user_data)
        login_response = requests.post(f"{base_url}{api_path}/login", json=login_data)
        access_token = login_response.json()["access_token"]
    
        # ╬сэюты хь яЁюЇшы№
        update_data = {
            "surname": "Petrov",
            "name": "Petr",
            "patronymic": "Petrovich"
        }
        url = f"{user_service_url}{user_api_path}/me"
        response = requests.put(
            url,
            json=update_data,
            headers={"Authorization": f"Bearer {access_token}"}
        )
    
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401]>.status_code

tests\services\user\test_user_endpoints.py:62: AssertionError
_____________________ TestUserProfile.test_update_status ______________________

self = <test_user_endpoints.TestUserProfile object at 0x00000233CBAC6C30>
user_service_url = 'http://localhost:8082', user_api_path = '/api/v1/users'
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
valid_user_data = {'login': 'testuser1764503944780@example.com', 'name': 'Ivan', 'password': 'SecurePassword123', 'patronymic': 'Ivanovich', ...}
login_data = {'login': 'testuser1764503944780@example.com', 'password': 'SecurePassword123'}

    def test_update_status(self, user_service_url, user_api_path, base_url, api_path, valid_user_data, login_data):
        """╬сэютыхэшх ёЄрЄєёр"""
        # ╨хушёЄЁшЁєхь ш тїюфшь
        requests.post(f"{base_url}{api_path}/register", json=valid_user_data)
        login_response = requests.post(f"{base_url}{api_path}/login", json=login_data)
        access_token = login_response.json()["access_token"]
    
        # ╬сэюты хь ёЄрЄєё эр "═х схёяюъюшЄ№" (2)
        url = f"{user_service_url}{user_api_path}/me/status"
        response = requests.put(
            url,
            json={"status": 2},
            headers={"Authorization": f"Bearer {access_token}"}
        )
    
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401]>.status_code

tests\services\user\test_user_endpoints.py:83: AssertionError
_________________ TestWorkspaceUsers.test_get_workspace_users _________________

self = <test_user_endpoints.TestWorkspaceUsers object at 0x00000233CBAC7230>
user_service_url = 'http://localhost:8082', user_api_path = '/api/v1/users'
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
valid_user_data = {'login': 'testuser1764503946088@example.com', 'name': 'Ivan', 'password': 'SecurePassword123', 'patronymic': 'Ivanovich', ...}
login_data = {'login': 'testuser1764503946088@example.com', 'password': 'SecurePassword123'}
db_cursor = <cursor object at 0x00000233CBBB8D70; closed: 0>
clean_workspace_data = None

    def test_get_workspace_users(self, user_service_url, user_api_path, base_url, api_path, valid_user_data, login_data, db_cursor, clean_workspace_data):
        """╧юыєўхэшх яюы№чютрЄхыхщ Ёрсюўхую яЁюёЄЁрэёЄтр"""
        # 1. ╨хушёЄЁшЁєхь яюы№чютрЄхы 
        requests.post(f"{base_url}{api_path}/register", json=valid_user_data)
        login_response = requests.post(f"{base_url}{api_path}/login", json=login_data)
        access_token = login_response.json()["access_token"]
        user_id = login_response.json()["user"]["id"]
    
        # 2. ╤ючфрхь Workspace ш яЁшт ч√трхь яюы№чютрЄхы  ўхЁхч ┴─ (Єръ ъръ Workspace Service ьюцхЄ с√Є№ эхфюёЄєяхэ)
        # ╤ючфрхь ЄрЁшЇ (хёыш эхЄ)
>       db_cursor.execute("INSERT INTO tariffs (name, description) VALUES ('Free', 'Free tariff') ON CONFLICT DO NOTHING RETURNING id")

tests\services\user\test_user_endpoints.py:142: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <cursor object at 0x00000233CBBB8D70; closed: 0>
query = "INSERT INTO tariffs (name, description) VALUES ('Free', 'Free tariff') ON CONFLICT DO NOTHING RETURNING id"
vars = None

    def execute(self, query, vars=None):
        self.column_mapping = []
        self._query_executed = True
>       return super().execute(query, vars)
E       psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type integer: "Free"
E       LINE 1: INSERT INTO tariffs (name, description) VALUES ('Free', 'Fre...
E                                                               ^

C:\Users\niksa\AppData\Local\Programs\Python\Python312\Lib\site-packages\psycopg2\extras.py:236: InvalidTextRepresentation
____________ TestWorkspaceUsers.test_get_workspace_users_forbidden ____________

self = <test_user_endpoints.TestWorkspaceUsers object at 0x00000233CBAC6810>
user_service_url = 'http://localhost:8082', user_api_path = '/api/v1/users'
base_url = 'http://localhost:8081', api_path = '/api/v1/auth'
valid_user_data = {'login': 'testuser1764503946550@example.com', 'name': 'Ivan', 'password': 'SecurePassword123', 'patronymic': 'Ivanovich', ...}
login_data = {'login': 'testuser1764503946550@example.com', 'password': 'SecurePassword123'}
db_cursor = <cursor object at 0x00000233CBBB9040; closed: 0>
clean_workspace_data = None

    def test_get_workspace_users_forbidden(self, user_service_url, user_api_path, base_url, api_path, valid_user_data, login_data, db_cursor, clean_workspace_data):
        """╧юя√Єър яюыєўшЄ№ яюы№чютрЄхыхщ ўєцюую ╨╧"""
        # 1. ╨хушёЄЁшЁєхь яюы№чютрЄхы  1 (┬ырфхыхЎ ╨╧)
        requests.post(f"{base_url}{api_path}/register", json=valid_user_data)
        login_response = requests.post(f"{base_url}{api_path}/login", json=login_data)
        user1_id = login_response.json()["user"]["id"]
    
        # 2. ╤ючфрхь ╨╧ фы  яюы№чютрЄхы  1
>       db_cursor.execute("INSERT INTO tariffs (name, description) VALUES ('Free', 'Free tariff') ON CONFLICT DO NOTHING RETURNING id")

tests\services\user\test_user_endpoints.py:181: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <cursor object at 0x00000233CBBB9040; closed: 0>
query = "INSERT INTO tariffs (name, description) VALUES ('Free', 'Free tariff') ON CONFLICT DO NOTHING RETURNING id"
vars = None

    def execute(self, query, vars=None):
        self.column_mapping = []
        self._query_executed = True
>       return super().execute(query, vars)
E       psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type integer: "Free"
E       LINE 1: INSERT INTO tariffs (name, description) VALUES ('Free', 'Fre...
E                                                               ^

C:\Users\niksa\AppData\Local\Programs\Python\Python312\Lib\site-packages\psycopg2\extras.py:236: InvalidTextRepresentation
=========================== short test summary info ===========================
FAILED tests/services/auth/test_auth_endpoints.py::TestUserLogin::test_login_success
FAILED tests/services/auth/test_auth_endpoints.py::TestRefreshToken::test_refresh_success
FAILED tests/services/auth/test_auth_endpoints.py::TestAdminRegister::test_admin_register_invalid_password_too_short
FAILED tests/services/user/test_user_endpoints.py::TestUserProfile::test_get_me_success
FAILED tests/services/user/test_user_endpoints.py::TestUserProfile::test_update_me_success
FAILED tests/services/user/test_user_endpoints.py::TestUserProfile::test_update_status
FAILED tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users
FAILED tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users_forbidden
ERROR tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users
ERROR tests/services/user/test_user_endpoints.py::TestWorkspaceUsers::test_get_workspace_users_forbidden
=================== 8 failed, 31 passed, 2 errors in 9.53s ====================
