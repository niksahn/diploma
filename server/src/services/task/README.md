# Task Service

Микросервис управления задачами для корпоративного мессенджера.

## Описание

Task Service отвечает за:
- Создание и управление задачами
- Назначение исполнителей и отслеживание статуса
- Прикрепление задач к чатам для обсуждения
- Ведение истории изменений задач
- Контроль доступа к задачам в рамках рабочих пространств

## Технологии

- **Go 1.23+**
- **Gin** - HTTP фреймворк
- **PostgreSQL** - база данных
- **pgx/v5** - драйвер PostgreSQL
- **Swagger** - документация API

## Структура проекта

```
task/
├── config/              # Конфигурация
├── data/
│   ├── database/        # Подключение к БД
│   ├── models/          # Модели данных
│   └── repository/      # Репозиторий для работы с БД
├── presentation/
│   ├── handlers/        # HTTP обработчики
│   └── models/          # Request/Response модели
├── docs/                # Swagger документация
├── main.go              # Точка входа
├── Dockerfile           # Docker образ
├── Makefile             # Команды для разработки
└── README.md            # Документация
```

## API Endpoints

### Задачи (13 эндпоинтов)

#### CRUD операции
- `POST /api/v1/tasks` - Создать задачу
- `GET /api/v1/tasks` - Список задач в РП
- `GET /api/v1/tasks/:id` - Информация о задаче
- `PUT /api/v1/tasks/:id` - Обновить задачу (создатель)
- `DELETE /api/v1/tasks/:id` - Удалить задачу (создатель)

#### Управление статусом
- `PUT /api/v1/tasks/:id/status` - Изменить статус

#### Управление исполнителями
- `POST /api/v1/tasks/:id/assignees` - Назначить исполнителей (создатель)
- `GET /api/v1/tasks/:id/assignees` - Список исполнителей
- `DELETE /api/v1/tasks/:id/assignees/:user_id` - Удалить исполнителя (создатель)

#### Прикрепление к чатам
- `POST /api/v1/tasks/:id/chats` - Прикрепить к чату (создатель)
- `GET /api/v1/tasks/:id/chats` - Список чатов задачи
- `DELETE /api/v1/tasks/:id/chats/:chat_id` - Открепить от чата (создатель)

#### История изменений
- `GET /api/v1/tasks/:id/history` - История изменений

## Переменные окружения

```bash
PORT=8085                                    # Порт сервиса
DB_HOST=postgres                             # Хост БД
DB_PORT=5432                                 # Порт БД
DB_NAME=messenger_db                         # Имя БД
DB_USER=user                                 # Пользователь БД
DB_PASSWORD=password                         # Пароль БД
AUTH_SERVICE_URL=http://auth-service:8081    # URL Auth Service
USER_SERVICE_URL=http://user-service:8082    # URL User Service
WORKSPACE_SERVICE_URL=http://workspace-service:8083  # URL Workspace Service
CHAT_SERVICE_URL=http://chat-service:8084    # URL Chat Service
```

## Статусы задач

| Код | Статус | Описание |
|-----|--------|----------|
| 1 | Создана | Задача создана, но работа не начата |
| 2 | В работе | Задача находится в активной разработке |
| 3 | На проверке | Задача завершена и ожидает проверки |
| 4 | Завершена | Задача успешно выполнена |
| 5 | Отменена | Задача отменена |

## Правила доступа

- **Создание задач**: Любой участник рабочего пространства
- **Просмотр задач**: Участники рабочего пространства
- **Изменение задач**: Только создатель задачи
- **Назначение исполнителей**: Только создатель задачи
- **Изменение статуса**: Любой участник рабочего пространства
- **Прикрепление к чатам**: Только создатель задачи

## Запуск

### Локально

```bash
# Установить зависимости
go mod download

# Запустить сервис
go run main.go

# Или через Makefile
make run
```

### Docker

```bash
# Собрать образ
docker build -t task-service .

# Запустить контейнер
docker run -p 8085:8085 \
  -e DB_HOST=postgres \
  -e DB_PORT=5432 \
  -e DB_NAME=messenger_db \
  -e DB_USER=user \
  -e DB_PASSWORD=password \
  task-service
```

### Docker Compose

Сервис интегрирован в общий `docker-compose.yml` проекта.

## Swagger документация

После запуска сервиса документация доступна по адресу:
```
http://localhost:8085/swagger/index.html
```

Для генерации/обновления документации:
```bash
make swagger
# или
swag init -g main.go
```

## Разработка

### Генерация Swagger документации

```bash
# Установить swag (если еще не установлен)
go install github.com/swaggo/swag/cmd/swag@latest

# Сгенерировать документацию
swag init -g main.go
```

### Сборка

```bash
# Локальная сборка
make build

# Или напрямую
go build -o task-service main.go
```

## Зависимости от других сервисов

- **PostgreSQL** - основная база данных
- **Kong Gateway** - маршрутизация и JWT валидация
- **Workspace Service** - проверка прав доступа к рабочим пространствам

## Примечания

1. Задачи могут создаваться только в существующих рабочих пространствах
2. Пользователь должен быть участником РП для создания задач
3. Исполнители автоматически проверяются на участие в РП
4. Задачи можно прикреплять только к чатам того же РП
5. История изменений ведется автоматически для всех операций
6. При удалении РП каскадно удаляются все связанные задачи
7. Создатель задачи имеет особые права на ее изменение и управление

## Лицензия

Apache 2.0




