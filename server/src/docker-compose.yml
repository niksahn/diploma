version: '3.8'

services:

  # Kong Gateway - единая точка входа
  kong:
    image: kong:3.4
    container_name: messenger_kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_LISTEN: 0.0.0.0:8002
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_PLUGINS: bundled,jwt,request-transformer,cors,prometheus
    ports:
      - "8080:8000"    # Kong Proxy (единая точка входа)
      - "8001:8001"    # Kong Admin API
      - "8002:8002"    # Kong Manager GUI
    volumes:
      - ./kong/declarative/kong.yml:/kong/declarative/kong.yml:ro
      - ./swagger-docs/kong-openapi.json
    restart: always

  postgres:
    image: postgres:15-alpine
    container_name: messenger_postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: messenger_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U user" ]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: messenger_auth_service
    ports:
      - "8081:8081"
    environment:
      PORT: 8081
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: messenger_db
      DB_USER: user
      DB_PASSWORD: password
      JWT_SECRET: your_jwt_secret_key_here_minimum_32_characters_long_for_production
      JWT_ACCESS_EXPIRATION: 3600
      JWT_REFRESH_EXPIRATION: 604800
      BCRYPT_COST: 12
    depends_on:
      postgres:
        condition: service_healthy
      kong:
        condition: service_started
    restart: always

  user-service:
    build:
      context: ./services/user
      dockerfile: Dockerfile
    container_name: messenger_user_service
    ports:
      - "8082:8082"
    environment:
      PORT: 8082
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: messenger_db
      DB_USER: user
      DB_PASSWORD: password
    depends_on:
      postgres:
        condition: service_healthy
      kong:
        condition: service_started
    restart: always

  workspace-service:
    build:
      context: ./services/workspace
      dockerfile: Dockerfile
    container_name: messenger_workspace_service
    ports:
      - "8083:8083"
    environment:
      PORT: 8083
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: messenger_db
      DB_USER: user
      DB_PASSWORD: password
      AUTH_SERVICE_URL: http://auth-service:8081
      USER_SERVICE_URL: http://user-service:8082
    depends_on:
      postgres:
        condition: service_healthy
      kong:
        condition: service_started
    restart: always

  chat-service:
    build:
      context: ./services/chat
      dockerfile: Dockerfile
    container_name: messenger_chat_service
    ports:
      - "8084:8084"
    environment:
      PORT: 8084
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: messenger_db
      DB_USER: user
      DB_PASSWORD: password
      AUTH_SERVICE_URL: http://auth-service:8081
      USER_SERVICE_URL: http://user-service:8082
      WORKSPACE_SERVICE_URL: http://workspace-service:8083
      WEBSOCKET_ENABLED: "true"
      WEBSOCKET_PING_INTERVAL: "30"
    depends_on:
      postgres:
        condition: service_healthy
      kong:
        condition: service_started
    restart: always

  task-service:
    build:
      context: ./services/task
      dockerfile: Dockerfile
    container_name: messenger_task_service
    ports:
      - "8085:8085"
    environment:
      PORT: 8085
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: messenger_db
      DB_USER: user
      DB_PASSWORD: password
      AUTH_SERVICE_URL: http://auth-service:8081
      USER_SERVICE_URL: http://user-service:8082
      WORKSPACE_SERVICE_URL: http://workspace-service:8083
      CHAT_SERVICE_URL: http://chat-service:8084
    depends_on:
      postgres:
        condition: service_healthy
      kong:
        condition: service_started
    restart: always

  # TODO: Реализовать complaint-service
  # complaint-service:
  #   build:
  #     context: ./services/complaint
  #     dockerfile: Dockerfile
  #   container_name: messenger_complaint_service
  #   ports:
  #     - "8086:8086"
  #   environment:
  #     PORT: 8086
  #     DB_HOST: postgres
  #     DB_PORT: 5432
  #     DB_NAME: messenger_db
  #     DB_USER: user
  #     DB_PASSWORD: password
  #     AUTH_SERVICE_URL: http://auth-service:8081
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     kong:
  #       condition: service_started
  #       restart: always


  # Swagger UI для документации API
  swagger-ui:
    image: swaggerapi/swagger-ui:v5.10.3
    container_name: messenger_swagger_ui
    environment:
      SWAGGER_JSON_URL: /swagger.json
      BASE_URL: /
      URLS: >
        [
          {"name": "Auth Service", "url": "/swagger-docs/auth.json"},
          {"name": "User Service", "url": "/swagger-docs/user.json"},
          {"name": "Workspace Service", "url": "/swagger-docs/workspace.json"},
          {"name": "Chat Service", "url": "/swagger-docs/chat.json"},
          {"name": "Task Service", "url": "/swagger-docs/task.json"},
          {"name": "Kong Gateway", "url": "/swagger-docs/kong.json"}
        ]
      URLS_PRIMARY_NAME: "Auth Service"
      TRY_IT_OUT_ENABLED: "true"
      DEFAULT_MODELS_EXPAND_DEPTH: "1"
      DEFAULT_MODEL_EXPAND_DEPTH: "3"
      DISPLAY_OPERATION_ID: "false"
      DISPLAY_REQUEST_DURATION: "true"
      DOC_EXPANSION: "list"
      FILTER: "true"
      MAX_DISPLAYED_TAGS: "10"
      SHOW_COMMON_EXTENSIONS: "true"
      SHOW_EXTENSIONS: "true"
    volumes:
      - ./swagger-docs:/usr/share/nginx/html/swagger-docs:ro
    ports:
      - "8089:8080"  # Swagger UI на порту 8089
    depends_on:
      kong:
        condition: service_started
    restart: always

volumes:
  postgres_data:
  kong_data:
